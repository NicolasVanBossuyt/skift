; http://www.ctyme.com/intr/int.htm

extern interrupt_handler
extern task_shedule

%macro  SAVE_REGS 0
        pushad 
        
        push ds
        push es
        push fs
        push gs

        push ebx
        mov bx,0x10
        mov ds,bx
        pop ebx
%endmacro

%macro  RESTORE_REGS 0
        pop gs
        pop fs
        pop es
        pop ds
        popad
%endmacro

%macro HANDLER_NAME 1
dd int_handler%1
%endmacro

%macro HANDLER 1
global int_handler%1
int_handler%1:
    cli
    SAVE_REGS
    push byte 0
    push %1

    call interrupt_handler
    
    add esp, 8
    RESTORE_REGS
    sti
    iret
%endmacro

%macro HANDLER_TASK_SWICH 1
global int_handler%1
int_handler%1:
    cli
    
    SAVE_REGS

    mov eax, esp    ; stack => eax
    push eax    ; push eax (esp)

    call task_shedule

    mov esp, eax    ; return value => stack

    mov al, 0x20    ; ack IRQ
    out 0x20, al

    RESTORE_REGS
    
    sti
    iret
%endmacro

%macro HANDLER_ERROR 1
global int_handler%1
int_handler%1:
    cli
    ; push byte 0 this is the error code push by the cpu
    SAVE_REGS
    push %1
    call interrupt_handler
    add esp, 8
    RESTORE_REGS
    sti
    iret
%endmacro

; CPU Exceptions

HANDLER 0 ; Divide-by-zero Error
HANDLER 1 ; Debug
HANDLER 2 ; Non-maskable Interrupt
HANDLER 3 ; Breakpoint
HANDLER 4 ; Overflow
HANDLER 5 ; etc... *see*: https://wiki.osdev.org/Exceptions
HANDLER 6
HANDLER 7
HANDLER_ERROR 8
HANDLER 9
HANDLER_ERROR 10
HANDLER_ERROR 11
HANDLER_ERROR 12
HANDLER_ERROR 13
HANDLER_ERROR 14
HANDLER 15
HANDLER 16
HANDLER 17
HANDLER 18
HANDLER 19
HANDLER 20
HANDLER 21
HANDLER 22
HANDLER 23
HANDLER 24
HANDLER 25
HANDLER 26
HANDLER 27
HANDLER 28
HANDLER 29
HANDLER 30
HANDLER 31

; Hardware interupte (IRQ)

HANDLER_TASK_SWICH 32 ; clock (Need a special handlder for task switching)
HANDLER 33 ; keyboard
HANDLER 34
HANDLER 35 ; COM2-4
HANDLER 36 ; COM1-3
HANDLER 37
HANDLER 38
HANDLER 39
HANDLER 40
HANDLER 41
HANDLER 42
HANDLER 43
HANDLER 44
HANDLER 45
HANDLER 46
HANDLER 47

HANDLER 48
HANDLER 49
HANDLER 50
HANDLER 51
HANDLER 52
HANDLER 53
HANDLER 54
HANDLER 55
HANDLER 56
HANDLER 57
HANDLER 58
HANDLER 59
HANDLER 60
HANDLER 61
HANDLER 62
HANDLER 63
HANDLER 64
HANDLER 65
HANDLER 66
HANDLER 67
HANDLER 68
HANDLER 69
HANDLER 70
HANDLER 71
HANDLER 72
HANDLER 73
HANDLER 74
HANDLER 75
HANDLER 76
HANDLER 77
HANDLER 78
HANDLER 79
HANDLER 80
HANDLER 81
HANDLER 82
HANDLER 83
HANDLER 84
HANDLER 85
HANDLER 86
HANDLER 87
HANDLER 88
HANDLER 89
HANDLER 90
HANDLER 91
HANDLER 92
HANDLER 93
HANDLER 94
HANDLER 95
HANDLER 96
HANDLER 97
HANDLER 98
HANDLER 99
HANDLER 100
HANDLER 101
HANDLER 102
HANDLER 103
HANDLER 104
HANDLER 105
HANDLER 106
HANDLER 107
HANDLER 108
HANDLER 109
HANDLER 110
HANDLER 111
HANDLER 112
HANDLER 113
HANDLER 114
HANDLER 115
HANDLER 116
HANDLER 117
HANDLER 118
HANDLER 119
HANDLER 120
HANDLER 121
HANDLER 122
HANDLER 123
HANDLER 124
HANDLER 125
HANDLER 126
HANDLER 127
HANDLER 128
HANDLER 129
HANDLER 130
HANDLER 131
HANDLER 132
HANDLER 133
HANDLER 134
HANDLER 135
HANDLER 136
HANDLER 137
HANDLER 138
HANDLER 139
HANDLER 140
HANDLER 141
HANDLER 142
HANDLER 143
HANDLER 144
HANDLER 145
HANDLER 146
HANDLER 147
HANDLER 148
HANDLER 149
HANDLER 150
HANDLER 151
HANDLER 152
HANDLER 153
HANDLER 154
HANDLER 155
HANDLER 156
HANDLER 157
HANDLER 158
HANDLER 159
HANDLER 160
HANDLER 161
HANDLER 162
HANDLER 163
HANDLER 164
HANDLER 165
HANDLER 166
HANDLER 167
HANDLER 168
HANDLER 169
HANDLER 170
HANDLER 171
HANDLER 172
HANDLER 173
HANDLER 174
HANDLER 175
HANDLER 176
HANDLER 177
HANDLER 178
HANDLER 179
HANDLER 180
HANDLER 181
HANDLER 182
HANDLER 183
HANDLER 184
HANDLER 185
HANDLER 186
HANDLER 187
HANDLER 188
HANDLER 189
HANDLER 190
HANDLER 191
HANDLER 192
HANDLER 193
HANDLER 194
HANDLER 195
HANDLER 196
HANDLER 197
HANDLER 198
HANDLER 199
HANDLER 200
HANDLER 201
HANDLER 202
HANDLER 203
HANDLER 204
HANDLER 205
HANDLER 206
HANDLER 207
HANDLER 208
HANDLER 209
HANDLER 210
HANDLER 211
HANDLER 212
HANDLER 213
HANDLER 214
HANDLER 215
HANDLER 216
HANDLER 217
HANDLER 218
HANDLER 219
HANDLER 220
HANDLER 221
HANDLER 222
HANDLER 223
HANDLER 224
HANDLER 225
HANDLER 226
HANDLER 227
HANDLER 228
HANDLER 229
HANDLER 230
HANDLER 231
HANDLER 232
HANDLER 233
HANDLER 234
HANDLER 235
HANDLER 236
HANDLER 237
HANDLER 238
HANDLER 239
HANDLER 240
HANDLER 241
HANDLER 242
HANDLER 243
HANDLER 244
HANDLER 245
HANDLER 246
HANDLER 247
HANDLER 248
HANDLER 249
HANDLER 250
HANDLER 251
HANDLER 252
HANDLER 253
HANDLER 254
HANDLER 255

section .data
global int_handlers
int_handlers:
    HANDLER_NAME 0
    HANDLER_NAME 1
    HANDLER_NAME 2
    HANDLER_NAME 3
    HANDLER_NAME 4
    HANDLER_NAME 5
    HANDLER_NAME 6
    HANDLER_NAME 7
    HANDLER_NAME 8
    HANDLER_NAME 9
    HANDLER_NAME 10
    HANDLER_NAME 11
    HANDLER_NAME 12
    HANDLER_NAME 13
    HANDLER_NAME 14
    HANDLER_NAME 15
    HANDLER_NAME 16
    HANDLER_NAME 17
    HANDLER_NAME 18
    HANDLER_NAME 19
    HANDLER_NAME 20
    HANDLER_NAME 21
    HANDLER_NAME 22
    HANDLER_NAME 23
    HANDLER_NAME 24
    HANDLER_NAME 25
    HANDLER_NAME 26
    HANDLER_NAME 27
    HANDLER_NAME 28
    HANDLER_NAME 29
    HANDLER_NAME 30
    HANDLER_NAME 31
    HANDLER_NAME 32
    HANDLER_NAME 33
    HANDLER_NAME 34
    HANDLER_NAME 35
    HANDLER_NAME 36
    HANDLER_NAME 37
    HANDLER_NAME 38
    HANDLER_NAME 39
    HANDLER_NAME 40
    HANDLER_NAME 41
    HANDLER_NAME 42
    HANDLER_NAME 43
    HANDLER_NAME 44
    HANDLER_NAME 45
    HANDLER_NAME 46
    HANDLER_NAME 47
    HANDLER_NAME 48
    HANDLER_NAME 49
    HANDLER_NAME 50
    HANDLER_NAME 51
    HANDLER_NAME 52
    HANDLER_NAME 53
    HANDLER_NAME 54
    HANDLER_NAME 55
    HANDLER_NAME 56
    HANDLER_NAME 57
    HANDLER_NAME 58
    HANDLER_NAME 59
    HANDLER_NAME 60
    HANDLER_NAME 61
    HANDLER_NAME 62
    HANDLER_NAME 63
    HANDLER_NAME 64
    HANDLER_NAME 65
    HANDLER_NAME 66
    HANDLER_NAME 67
    HANDLER_NAME 68
    HANDLER_NAME 69
    HANDLER_NAME 70
    HANDLER_NAME 71
    HANDLER_NAME 72
    HANDLER_NAME 73
    HANDLER_NAME 74
    HANDLER_NAME 75
    HANDLER_NAME 76
    HANDLER_NAME 77
    HANDLER_NAME 78
    HANDLER_NAME 79
    HANDLER_NAME 80
    HANDLER_NAME 81
    HANDLER_NAME 82
    HANDLER_NAME 83
    HANDLER_NAME 84
    HANDLER_NAME 85
    HANDLER_NAME 86
    HANDLER_NAME 87
    HANDLER_NAME 88
    HANDLER_NAME 89
    HANDLER_NAME 90
    HANDLER_NAME 91
    HANDLER_NAME 92
    HANDLER_NAME 93
    HANDLER_NAME 94
    HANDLER_NAME 95
    HANDLER_NAME 96
    HANDLER_NAME 97
    HANDLER_NAME 98
    HANDLER_NAME 99
    HANDLER_NAME 100
    HANDLER_NAME 101
    HANDLER_NAME 102
    HANDLER_NAME 103
    HANDLER_NAME 104
    HANDLER_NAME 105
    HANDLER_NAME 106
    HANDLER_NAME 107
    HANDLER_NAME 108
    HANDLER_NAME 109
    HANDLER_NAME 110
    HANDLER_NAME 111
    HANDLER_NAME 112
    HANDLER_NAME 113
    HANDLER_NAME 114
    HANDLER_NAME 115
    HANDLER_NAME 116
    HANDLER_NAME 117
    HANDLER_NAME 118
    HANDLER_NAME 119
    HANDLER_NAME 120
    HANDLER_NAME 121
    HANDLER_NAME 122
    HANDLER_NAME 123
    HANDLER_NAME 124
    HANDLER_NAME 125
    HANDLER_NAME 126
    HANDLER_NAME 127
    HANDLER_NAME 128
    HANDLER_NAME 129
    HANDLER_NAME 130
    HANDLER_NAME 131
    HANDLER_NAME 132
    HANDLER_NAME 133
    HANDLER_NAME 134
    HANDLER_NAME 135
    HANDLER_NAME 136
    HANDLER_NAME 137
    HANDLER_NAME 138
    HANDLER_NAME 139
    HANDLER_NAME 140
    HANDLER_NAME 141
    HANDLER_NAME 142
    HANDLER_NAME 143
    HANDLER_NAME 144
    HANDLER_NAME 145
    HANDLER_NAME 146
    HANDLER_NAME 147
    HANDLER_NAME 148
    HANDLER_NAME 149
    HANDLER_NAME 150
    HANDLER_NAME 151
    HANDLER_NAME 152
    HANDLER_NAME 153
    HANDLER_NAME 154
    HANDLER_NAME 155
    HANDLER_NAME 156
    HANDLER_NAME 157
    HANDLER_NAME 158
    HANDLER_NAME 159
    HANDLER_NAME 160
    HANDLER_NAME 161
    HANDLER_NAME 162
    HANDLER_NAME 163
    HANDLER_NAME 164
    HANDLER_NAME 165
    HANDLER_NAME 166
    HANDLER_NAME 167
    HANDLER_NAME 168
    HANDLER_NAME 169
    HANDLER_NAME 170
    HANDLER_NAME 171
    HANDLER_NAME 172
    HANDLER_NAME 173
    HANDLER_NAME 174
    HANDLER_NAME 175
    HANDLER_NAME 176
    HANDLER_NAME 177
    HANDLER_NAME 178
    HANDLER_NAME 179
    HANDLER_NAME 180
    HANDLER_NAME 181
    HANDLER_NAME 182
    HANDLER_NAME 183
    HANDLER_NAME 184
    HANDLER_NAME 185
    HANDLER_NAME 186
    HANDLER_NAME 187
    HANDLER_NAME 188
    HANDLER_NAME 189
    HANDLER_NAME 190
    HANDLER_NAME 191
    HANDLER_NAME 192
    HANDLER_NAME 193
    HANDLER_NAME 194
    HANDLER_NAME 195
    HANDLER_NAME 196
    HANDLER_NAME 197
    HANDLER_NAME 198
    HANDLER_NAME 199
    HANDLER_NAME 200
    HANDLER_NAME 201
    HANDLER_NAME 202
    HANDLER_NAME 203
    HANDLER_NAME 204
    HANDLER_NAME 205
    HANDLER_NAME 206
    HANDLER_NAME 207
    HANDLER_NAME 208
    HANDLER_NAME 209
    HANDLER_NAME 210
    HANDLER_NAME 211
    HANDLER_NAME 212
    HANDLER_NAME 213
    HANDLER_NAME 214
    HANDLER_NAME 215
    HANDLER_NAME 216
    HANDLER_NAME 217
    HANDLER_NAME 218
    HANDLER_NAME 219
    HANDLER_NAME 220
    HANDLER_NAME 221
    HANDLER_NAME 222
    HANDLER_NAME 223
    HANDLER_NAME 224
    HANDLER_NAME 225
    HANDLER_NAME 226
    HANDLER_NAME 227
    HANDLER_NAME 228
    HANDLER_NAME 229
    HANDLER_NAME 230
    HANDLER_NAME 231
    HANDLER_NAME 232
    HANDLER_NAME 233
    HANDLER_NAME 234
    HANDLER_NAME 235
    HANDLER_NAME 236
    HANDLER_NAME 237
    HANDLER_NAME 238
    HANDLER_NAME 239
    HANDLER_NAME 240
    HANDLER_NAME 241
    HANDLER_NAME 242
    HANDLER_NAME 243
    HANDLER_NAME 244
    HANDLER_NAME 245
    HANDLER_NAME 246
    HANDLER_NAME 247
    HANDLER_NAME 248
    HANDLER_NAME 249
    HANDLER_NAME 250
    HANDLER_NAME 251
    HANDLER_NAME 252
    HANDLER_NAME 253
    HANDLER_NAME 254
    HANDLER_NAME 255